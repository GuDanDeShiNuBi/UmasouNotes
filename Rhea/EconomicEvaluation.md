### 经评开发记录

- [x] 将管理员用户管理与教师用户管理界面进行统一，合并为一个，去除了manageruser_tea
- [x] 导出学生账号与教师账号
- [x] 设计并搭建方案编辑界面（基础数据）
- [x] 编辑基础数据界面：数据输入、保存、自动计算、更新
- [x] 搭建发电量变界面，编辑发电量表的数据,保存数据，更新数据
- [x] 保存当前数据时，根据计算公式，更新并保存其他表受影响的数据

- [x] 确认各数据单位，计算前需进行数据转换（百分号，万元，元）
- [x] decimal.parse改为：1、decimal.tryparse 2、convert.todecimal（数据库源数据，rows[][]）否则数据过大时会报错或数据异常
- [x] 将各表计算数据分离到一个单独的类中
- [x] 部分合计数据未计算
- [x] 数据计算后，需保存两次才能正确保存，部分表数据需等待其他表计算完成后才能正确计算
- [x] 概算最终计算数值，进入经评后应换算为万元
- [x] 计算数值小数点后有效位限制
- [x] 数据库sol表数据,部分可为空，部分不能为空，导致界面未输入数据部分为空，部分为0；
  - [x] 已全部改为不为空，方案初始界面显示0
- [x] 删除方案功能完善
  - [x] 删除教师账户时，该教师账户下学生账户是否删除，学生的方案是否删除
  - [x] 目前为删除教师账号，所属学生账号，学生方案均删除
- [x] 删除用户功能完善
- [x] 目前账号不能同时登录概算和经评两个软件，设置是一个账号同一时间只能登录一台设备
- [x] 初次创建方案，进入方案编辑界面后报空，UpdateInputFiled_BD
- [x] 评分规则设定：1、首先对比基础数据中的必填项（即参数正确性），其中规划装机容量改为范围值。2、对比基础数据中概算数据是否与概算软件一致；3、评分表各项数据分值为12.5分，共8项。除每瓦投资额外，各项数据并按从大到小的顺序降序排列，每瓦投资额按照从小到大的顺序排列，第一名得为12.5分，按照顺序得分依次减少，扣分值为0.5分，最低分为5分
  - [ ] 评分还需方案数据完整后进行验证 
- [x] 教师管理用户界面，导出学生账号后，界面无法触发事件。(判断桌面进程是否结束，即filemanager是否返回为null)
- [x] 方案进行导出保存文件后，如何桌面进程点击关闭或者取消保存，返回应用会无法触发界面
- [] irr计算公式还需测试，部分数据不符合计算要求，目前返回为0
- [ ] 百分数进行限制，0到100
- [x] 向数据库存取数据时避免使用科学计数，造成数字结果为：12E+3
- [x] 导出文件至电脑。中途关闭后返回软件再重新导出，软件会报表格名已存在
  - [x] 取消保存后未移除事件监听
- [x] 教师重命名方案名时，所属学生方案的teachersolname也需修改
- [x] 完善经评保存提示功能

- [x] 更改经评数据库sol表设计
- [x] 更改方案编辑界面，界面排版修改。组件类型与还贷方式修改为下拉框的方式。增加一行最小规划装机容量 。部分数据需要居中，左右对齐
- [x] 修改发电量部分的计算公式
- [x] 增加当前页数据是否发生变化判断
- [x] 修改评分判断规则
- [x] 优化两个软件UI界面，调整UI布局
- [x] 修改概算方案编辑界面所需基础数据读取方式
- [x] 单位项设置为固定数据，读取单位列所需数据
- [ ] 去除单位项的评分判断
- [x] 将为0的规格数据显示为空
- [x] 创建教师账号时，设置可创建的最大学生数量，数据库user表添加此项
- [x] 修改添加用户界面
- [x] 编辑用户界面增加学生数量输入框
- [x] 数据库用户账号区分大小写,验证登录与判断是否用户名重复时。两个软件均修改
- [x] 基础数据界面增加Table、方向键切换输入框功能
  
- [x] 风力发电量=P（v）* 风力发电总容量 * 整机转换效率/ 1000 ，当这三项值改变后，风力发电量随之改变。
- [x] 光伏发电量=发电量表总实际发电量，需点击保存按钮后才会改变
- [x] 点击返回按钮，弹出是否保存当前页数据后，点击不保存，还会弹出。点击不保存后需清除当前页输入数据
- [x] 目前为用户名密码登录，没有其他认证项。所以当新建用户时查找所有用户下是否存在重复名称
- [x] 经评：教师之间方案名不能重复，不同教师下的学生方案名可以重复，教师不能与自己学生的方案名重复
- [x] 概算：所有方案之间方案名均不能重复，数据库表设计有关。已修改为：教师之间方案名不能重复，不同教师下的学生方案名可以重复，教师不能与自己学生的方案名重复
- [x] 解决：教师创建学生账号时，需全局查找是否存在该学生账号。
- [x] deleteuser 中删除方案数据需修改
- [x] 测试新建用户、删除用户、新建方案、删除方案
- [x] 概算数据库 num字段
- [x] 修改概算数据库部分表设计，之前solname作为标识，现在改为solid。修改所有方案中以solname为依据的数据库操作程序，修改权限，不同教师间的学生方案名可以重复
- [x] 管理员用户编辑界面增加编辑学生数量选项。程序修改
- [x] 修改账号用户名后，两个软件对应sol中的用户名也要修改
- [x] 创建概算标准测试题与答案，测试
- [x] 修改'是否替换文件'有时不显示bug,，设置UI优先级
- [ ] 概算方案数据页数过多，数据分类多，输入繁琐：1、考虑修改界面布局，缩小表格大小；2、增加table键切换输入框（table键切换横向输入框，上下键切换到数量输入框）；3、增加表格数据导入功能
- [x] 概算软件增加table键，上下键切换当前页输入框
- [ ] 复制概算工程至unityproject文件夹，进行概算滑动列表数据展示方式与数据读取方式修改

- [x] 经评，打开学生方案界面后，再次进入教师方案界面，最小规划装机容量输入框丢失bug
- [x] 修改概算导出数据单位及小数保留位数，改为万元与经评一致
- [x] 优化概算导出表表格
- [x] 概算教师方案编辑界面，点击保存后，当多个范围值输入错误时，会跳出当前界面
- [x] 经评 学生方案保存是数据错乱
- [x] 经评 评分导出后未显示学生方案
- [x] 经评，评分导出表增加 单位，计算结果两列数据
- [x] 经评，评分时，包含多个学生评分时，仅显示了一个学生方案数据
- [x] 评分表方案按照名次依次排列
- [x] 多次评分出现错误， 评分列表缓存清除
- [x] 概算sol_output表数据 需点击方案输入界面的费用合计导出按钮，才会更新数据，否则数据为上次计算数据，导致评分不正确。改为保存方案时，更新对应soloutput表数据
- [x] 概算评分排名修改，总投资相等时，分数相等，名次相等
- [x] 管理员评分时报错，sql语句中查询教师方案id错误
- [x] 经评sol_output表数据 需点击方案输入界面的费用合计导出按钮，才会更新数据，否则数据为上次计算数据，导致评分不正确。改为评分时，更新对应方案soloutput表数据
- [x] 经评光伏发电系统与风力发电系统不能作为比较值
- [ ] 经评，保存方案数据时，用时过长，可考虑剥离优化
- [ ] 两个软件缺少方案数据进行测试，开发人员没有相关知识，无法确定数据的合理性与依据
- [x] 教师方案列表界面排序，教师方案显示在最上面，学生在其后。两个软件均修改
- [x] 风力发电量计算公式修改
- [x] 售电收入计算公式修改
- [x] 经评方案数据输入限制，数据限制为12位，百分数限制为0——100
- [x] 清除软件中按钮与输入框导航
- [x] 限制数据输入时包含逗号，限制登录输入框输入位数
- [x] 发电量表衰减比率输入限制（0-100，保留三位小数）

- [x] 概算、经评软件白皮书编写。（内容包含，软件介绍、软件运行配置环境、软件操作说明包括一些运行图片）
- 20220720
- [x] github已经上传更新到软件最新版
- [x] 概算经评工程不要轻易修改，可将工程拷贝到其他位置，作为副本平时使用
  
       


### 相关资料

- [npv计算](https://support.microsoft.com/zh-cn/office/npv-%E5%87%BD%E6%95%B0-8672cb67-2576-4d07-b67b-ac28acf2a568)
- [pmt](https://support.microsoft.com/zh-cn/office/pmt-%E5%87%BD%E6%95%B0-0214da64-9a63-4996-bc20-214433fa6441)
  - public static double PMT(decimal yearlyInterestRate, decimal totalNumberOfMonths, decimal loanAmount)
    {
        var rate = (double)yearlyInterestRate / 100 ;
        var denominator = Math.Pow((1 +  rate),(double) totalNumberOfMonths) - 1;
        return (rate + (rate / denominator)) *(double) loanAmount;
    }
- IRR 内部收益率计算
  - https://www.codeproject.com/Tips/461049/Internal-Rate-of-Return-IRR-Calculation
  - https://github.com/srbrettle/Financial-Formulas-Library-.NET-Standard
  - https://support.microsoft.com/zh-cn/office/irr-%E5%87%BD%E6%95%B0-64925eaa-9988-495b-b290-3ad0c163c1bc?msclkid=46ac8e95cfff11ec8accbc0b2d8186b7
  - https://zhuanlan.zhihu.com/p/425433706?msclkid=ce21edc6d00511ec9a816d2cee8e08ce
  - https://zhuanlan.zhihu.com/p/350931499?msclkid=4c635bf0d00b11ecba48b659caf452b2
  - https://blog.csdn.net/qianyun6/article/details/23022441?msclkid=8e97c338d00f11ec9dc10e9aab11c38d
  - https://blog.csdn.net/weixin_41276332/article/details/78725340?msclkid=6c4f2ef0d02711eca25016c15d70ad02
- [Financial](https://github.com/Hesapkurdu/hk-financial-functions)

### 测试步骤
- 创建ws教师账号
- 创建ws教师经评方案
- 创建ws教师概算方案
- 创建ws01学生概算方案
- 创建ws01学生经评方案
- 测试ws教师经评方案数据
- 测试ws教师概算方案数据
- 测试ws01学生概算方案数据
- 测试概算评分
- 测试ws01学生经评方案数据
- 测试经评评分
- 对比各表计算结果：对比表2发电量表,对比表3,4,5,6,7,8,10,11
#### 测试问题
- [x] 概算其他费用概算表。单位为%的数据，费率项计算时需/100，计算基数项默认万元；单位为wp的费率/数量指的是数量，计算基数为单价元
- [x] 经评ws01学生方案两次导出数据不同，计算结果不同：发电量表数据未正确保存
- [x] 光伏电站成本，风力电站成本，数据库数据小数点有效位数限制调整，由2位调整至3位
- [x] 概算方案部分的数据输入过小时，产生的折旧费，维修费，总成本费用就会过小.而规划装机容量决定着初始发电量，售电收入就会过大,造成利润总额过大。双方不成比例，数据异常
- [x] 使用float类型设计mysql数据时，保存至mysql的数据小数点后精度丢失。改为decimal,MySQL在内部把DECIMAL数据类型存储为字符串，更精确地保留它们的值
  - [mysql中float与decimal](https://blog.csdn.net/donghaixiaolongwang/article/details/74905954) 
- [x] 将数据库所有数值由float改为decimal类型
- [x] 导出评分后，界面跳转错误，导出数据错误
- [x] 教师经评方案中概算部分数据的依据来源，装机容量依据来源；学生经评方案中装机容量依据来源，如何确定装机容量值
  - [x] 教师随机选择自己的概算数据，学生选择指定概算方案的数据；两项不能作为对比项，不能确定学生的方案数据在教师方案数据的范围内
  - [x] 解决：教师与学生装机容量值来源由统一题目计算得出；判断总投资数据范围即可判断出建设期等数据是否正确
- [x] 数据库发电量表数据保存错误，需将float改为decimal
- [x] 还贷方式限制输入0、1
- [x] 去除界面数据小数点后多余0
- [x] 概算评分导出，多次导出分数错误，且低于20分
- [x] 方案重命名数据未清除
  
- [x] 内部收益率取值范围：可以为负数，可以大于1
- [x] 经评新建方案后进入方案编辑界面报错：未设置经评方案对应的概算方案id
- [x] 经评计算后的值清除小数点后末尾无效0
- [x] 经评软件增加保存提示
- [x] 教师添加学生账号时未添加成功：学生列表被提前清除
- [x] 管理员删除教师账号后，管理员导出教师账号时导出失败：界面跳转后未连接概算数据库
- [x] 优化概算方案输入界面，修改上方选择列表
- [x] 修改新建方案，修改密码重新登录等提示功能
- [x] 解决excel导出表格缓存问题，导出表格时取消导出操作，下次进行导出操作时内容会多出之前取消导出的内容
- [ ] 导出文件时，文件被占用，有时会卡住。可修改为文件名重复，不让其替换文件
- [ ] 经评保存方案数据，用时过长
  
- [x] 登录，鼠标点击用户名，没有光标，给登陆框添加光标。（两款软件均需修改）
- [x] “设计”，“新建方案”不要这么大，需要设计UI界面。（两款软件均需修改）
- [x] 规划装机容量区间，改为两行，新增一个“最小规划装机容量”
- [x] “按资计算器”写成了“投资计算期”，且左对齐，居中、右对齐没有显示出来
- [x] 基础数据、发电量表，向上弹出的效果不一致，按照基础数据表单进行统一
- [x] TAB、方向键不起作用
- [x] 组件类型、还款方式修改为下拉框选择
- [x] 合计效率没有意义，可删掉，平均效率需要保留两位小数
- [x] 发电量表逻辑不清
- [x] 电站成本逻辑不清
- [x] 年工资用了元作为单位
- [x] “管理”中相关title含义不清，顶部用户管理改为教师管理，添加用户改为添加学生，修改教师密码。（两款软件均需修改）
- [x] 学生界面进入，修改为其他模块按钮置灰。（两款软件均需修改）
- [x] 在新建教师账号时对添加一个输入框，对该教师账号下可创建的学生数量做限制。（两款软件均需修改）
- [x] 概算单位列设置为固定数据，不需要老师进行输入
- [x] 概算规格和单位为0的数据项，显示为空或者/
- [x] 经评 学生新建方案时，提示选择自己的概算方案，教师的经评方案
- [x] 经评 判断是否需要保存的依据，目前为判断界面是否有输入框触发事件，可改为将界面数据与数据库数据对比
- [x] 经评选填项不参与对比评分
- [x] 经评，判断光伏发电系统+风力发电系统是否在规划装机容量范围内，光伏总发电量=发电量变实际发电合计，风力总发电量按照仿真规划计算
- [x] 经评，修改评分导出表，excel布局
  
- 20220906
- [x] 两个软件退出登录问题：当网络情况不好时，关闭软件无法退出登录。在此处可以做一个循环操作，在一段时间内循环设置登录状态,首先判断该账号是否登录，如果是已经登录状态，则再次将状态设置为未登录,如果在设置时间内未设置成功则保存存储状态，用于下次登录判断。
  - 已解决，还需测试
- [ ] 导出结果还是存在科学计数:当结果数据过大时会采用科学计数
  - 解决方式：存在科学计数的值，均是不正确的值，可以改为0
- [x] 教师账号新建学生账号数量可以为0，且会导出表格。2个软件均已修改
- [x] admin账号编辑教师信息的时候直接显示教师账号密码。2个软件均修改
- [x] 学生方案管理界面未对齐
- [x] 评分修改
  - 评分规则设定：1、首先对比基础数据中的必填项（即参数正确性），其中规划装机容量改为范围值。
  - 2、对比基础数据中概算数据是否与概算软件一致；
  - 3、对比学生的装机容量是否在教师的装机容量范围内（与教师经评对比）。
  - 4、对比输入的装机容量是否等于光伏发电系统+风力发电系统（自身方案做对比）
  - 5、评分表各项数据分值为12.5分，共8项。每瓦投资额、投资回收期、平均贴现成本越小分值越高，按照从小到大的顺序排列，第一名得为12.5分，按照顺序得分依次减少，扣分值为0.5分，最低分为5分。其余各项数据并按从大到小的顺序排列。
- [x] 经评软件数据输入限制，当输入负数时，数据置为零
- [x] UI布局统一优化（两个软件）
- [x] 评分导出表增加每项评分数据的评分标准
  
- 20221011
- [x] 评分前进行方案中'其他资产'项的判断，不得小于0
- [x] npv税前、npv税后，IRR内部收益率计算测试
- [x] 部分数据项与概算清单中数据单位对比进行单位修改
- [x] 单位修改（kW·h）

- 20221025
- [ ] 保存方案，软件出现bug,网络异常，sql执行失败