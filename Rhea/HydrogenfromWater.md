### 相关知识库
- Matlab结合C#混合编程
  - 1、将Matlab .m文件放置VS项目文件Debug下，通过MLApp读取。目前无变量的程序测试通过，氢能程序程序测试未通过
  - 2、将matlab函数制成DLl文件，VS添加引用进行调用。无方法体的函数无法做成dll,不是.m的文件无法做成dll
  - 两种方法发布的应用，运行电脑没有mablab运行环境均不能打开matlab figure图表。第一种方法，目标电脑没有matlab运行环境，函数与图表均不能响应
  - matlab中涉及到simulink的程序无法调用
  - 该问题暂未解决，改为可持续开发

- PLC结合U3d开发
  - 1、U3d连接PLC硬件直接进行通讯
  - 2、U3d连接PLC仿真软件进行通讯
    - PLCSim:可编程控制器模拟软件，它在step7集成状态下实现无硬件模拟（需使用PLCSim_Advanced才可进行仿真）
    - step7
    - TIA博图
  - [博图与plc仿真软件通讯配置](https://blog.csdn.net/qq_42504097/article/details/125394487)
  - [C#读取PLC数据详细步骤](https://www.bilibili.com/video/BV1jK4y1t77a/)
  - PLC与C# 常用数据类型转换
    - PLC	  C#
      Bool	Bool
      Word	ushort
      Int	  ushort
      Dword	uint32
      Dint	uint
      byte	byte
      Real	double
  - 博图中 DBX读取位，比如bool类型；DBW读取字；DBD读取数值
  - [c#使用s7.net读取Plc-DB块](https://blog.csdn.net/weixin_39237340/article/details/125516266)
  - [c#使用s7.net读取Plc-DB块](https://www.cnblogs.com/minily/p/13324120.html)
  - [c#使用s7.net与plc通讯](https://blog.csdn.net/weixin_38801976/article/details/116456807)
  - c#使用s7.net读取plc字节
    - [1](https://www.csharpcodi.com/csharp-examples/S7.Net.Plc.ReadBytes(DataType,%20int,%20int,%20int)/)
    - [2](https://blog.csdn.net/qq_36669241/article/details/126104532)
    - [3](https://www.cnblogs.com/xhubobo/p/14573092.html)


### 开发记录
  - 确认软件开发过程中数据内容如何进行读取，是否需要连接PLC实体设备
  - 获取软件所需的各项数据列表（包括数据名称、类型、值）
  - PLC型号确认
  - 创建数据库，PLC的数据为实时读取，无需创建相关数据表，仅创建用户管理的相关数据表
  - 数据库用户表各项属性确认，如何注册、绑定设备、登录状态设定
  - 确认软件每页所需UI内容
  - 搭建项目框架

  - [x] 登录界面  
    - [x] 登录页UI界面搭建
    - [x] 账号密码输入
      - [x] 区分大小写
      - [x] 限制输入位数
      - [x] 密码加密显示
      - [x] 与数据库账号密码对比
        - [x] 账号密码信息错误提示
      - [x] 登录信息存储（账号信息，绑定设备信息）
    - [x] 记住密码功能  
    - [x] 忘记密码  
    - [x] 联系我们
      - [x] '联系我们'窗口搭建
      - [x] '联系我们'窗口信息读取，界面逻辑实现
    - [x] 登录跳转
  
  - [x] 顶部菜单栏
    - [x] UI搭建
    - [x] UI逻辑实现
    - [x] UI效果实现（按钮放上、选中效果）
    - [x] 账号信息展示
    - [x] 退出账号功能实现
  
  - [x] 首页
    - [x] UI界面搭建，界面自适应
      - [x] 环形图绘制
        - [x] pLc数据接入
      - [x] 折线图绘制
        - [x] 30日历史数据：是否只显示近30日内有运行数据的那些天，x轴是否固定30刻度
        - [x] mysql历史数据查询
      - [x] 水位图绘制
        - [x] plc数据接入
      - [x] 饼状图
        - [x] plc数据接口
      - [x] 光伏、市电输入功率进度图

  - [x] 实时监控
    - [x] 基础UI界面搭建
    - [x] 实时制氢量、发电量折线图绘制
      - [x] 折线图问题：由于时间点太多，一刻度为一小时，一刻度内有60个数据点，所有无法显示折线图圆点。除非将时间范围缩短，每刻度内数据点减少，才能显示。目前改为去除折线图圆点
    - [x] plc数据处理
      - [x] 基础数据读取与计算
      - [ ] 告警逻辑判断
  - [x] 基础配置页
    - [x] UI界面搭建
      - [x] 基础UI
      - [x] 表格绘制
    - [x] 添加设备
      - [x] UI窗口搭建
      - [x] 窗口交互实现，输入框输入限制，输入添加判断，逻辑跳转
      - [x] 添加设备功能实现
    - [x] 基础配置页表格数据读取与更新
      - [x] 根据设备编号、账号筛选设备信息
      - [x] 重置设备信息
      - [x] 操作后更新数据
    - [x] 修改设备信息
      - [x] 设备信息页
        - [x] 基础UI界面搭建
        - [x] 界面交互逻辑实现
        - [x] 设备信息展示
        - [x] 账号信息与密码修改
    - [x] 删除设备
      - [x] 删除用户账号相关信息
      - [x] 删除设备相关的其他数据信息(历史数据、实时数据、告警信息)

  - [x] 故障告警
    - [x] 界面搭建
      - [x] 基础UI搭建
      - [x] 表格制作
      - [x] 故障模块下拉列表制作
      - [x] 日历制作
        - [x] 日期时间段选择
    - [x] 界面功能实现
      - [x] 表格数据读取
      - [x] 通过指定日期区间与指定故障模块筛选记录
      - [x] 重置记录
      - [x] 清除所有记录
      - [x] 导出选择记录
        - [x] 将选择数据绘制成excel并导出

  - [x] 数据查询页
    - [x] 基础界面搭建
    - [x] 历史数据查询
      - [x] 历史数据表格搭建
      - [x] 各项数据查询展示
      - [x] 数据筛选、清除
      - [x] 所选数据导出excel
    - [x] 数据报表
      - [x] 数据报表表格搭建
      - [x] 各项数据查询展示
      - [x] 数据筛选、清除
      - [x] 所选数据导出excel
    - [x] 清除数据会把历史数据、数据报表数据都清除掉
  

  - [x] 增加了版本控制
  - [x] 确认PLC输出数据
  - [x] 确认软件数据与计算公式
  - [x] 当日实时数据存储：储氢量、发电量。历史数据存储：是否需要每五分钟更新一次当天运行数据，还是仅在用户退出时更新一次，或者plc断开关闭前更新
  - [x] 软件自适应问题（建议设置两个分辨率，指定分辨率），由于图片文字拉伸问题，取消Windows窗口设置，改为自定义
  - [x] 软件最小化、最大化、隐藏、还原、拖动操作完成
  - [x] 密码加密
  - [x] 提示信息
  - [x] 软件数据更新：每页数据按照页面需求进行读取，首页数据改为5s—10s更新,以后续实际测试为准。制氢量发电量数据在登录后则在后台一直进行更新，每五分钟更新一次，存储至数据库并绘制到折线图。
    - [x] 实时监控页数据与首页数据更新时长间隔一致，由于存在运行状态的变化，数据变化慢将引起误差。
  - [x] 软件相关指定数据放入数据库进行读取
  - [x] plc数据接口空出，编写各个页面plc数据处理
    -  string userjson = TableToJson.ToJson(dataSet.Tables[0]);
            allClimates = JsonUtility.FromJson<ClimateDatas>(userjson);
  - [x] 软件未连接plc也需确保软件可运行，管理员进行设备管理
  - [x] 实时监控界面，每5s更新检测一次各模块数据，当有模块发生告警时，会进行告警信息的记录。此时判断一段时间内告警信息是否相同，相同则不需进行记录。
  - [x] 告警信息，备注为具体告警数据
  
- 20221011
- [x] 当日发电量、制氢量、光伏输出功率、市电输出功率、当日用水量均是增量。当日设备存在多次关闭开启时，则需要记录上次的总数据，在此基础上进行增加。（燃料电池、市电或光电关闭计算当日运行时长内发电量、制氢量储存至数据库，当日内重新开启的话，则在此基础上累加）
-  储存到历史数据的触发条件 
   -  1、软件关闭之前
   -  2、光伏电源关闭、水电解槽关闭、市电电源关闭、氢气出口关闭
- [x] 水电解槽电压值不对
- [x] 实时监控中，制氢量、发电量改为某一时刻的实时数据，原来为运行时段内的总数据。从折线图改为散点图
- [ ] 实时监控界面‘当日制氢量’图随着水电解槽电压波动，电压波动0.01，制氢量波动1，制氢量原值=300
- [x] 如果某个模块并没有启动，则不监控其告警情况
- [x] 软件流程设计
  - 1、登录完成之后首先判断软件与plc的连接情况
    - 1、1 已经连接
      - 读取plc各模块数据前，进行该模块的开启情况判断
        - 如果开启，则可进行该模块的数据读取，告警判断
    - 1、2 未连接
      - 首页只显示发电量制氢量历史数据
      - 实时监控页数据均为0，及不进行操作
      - 数据查询页正常操作
      - 故障告警页只显示历史数据
      - 基础配置页正常操作
- [x] 软件plc重连
- [x] 当日运行时长=当日已累计时长+（当前时间-启动时间）
  - 当日累计时长的存储条件
    - 1、软件关闭
    - 2、如果该模块之前为开启状态，后面检测为关闭状态
- [x] 软件与设备连接情况处理
  - [x] 增加连接状态（账号信息那一栏）：已连接、未连接  
  - [x] 登录软件后，设备未开启，后台进行持续的重连操作。
  - [x] 使用过程中，与plc断开连接，弹出提示窗口‘设备已断开’
  - [x] 设备进行连接后，提示‘设备已连接’，更新连接状态

- [x]历史数据是否需要定期清除
- [x] 账号登录后，清除该账号以往实时数据记录

- [x] 软件关闭前记录当日历史数据
- [x] 需要将当日制氢量、发电量等数据的计算放在‘首页’数据更新中，不能放在软件退出之前的历史数据储存过程中，因为plc先断开，后关闭软件时无法读取plc数据 
- [x] 不能在首页数据更新中，将实时运行时长存储到数据库，因为下次读取时长会多出一部分，造成累加
- [x] 从“添加设备页、账号信息修改页”往“首页”跳转时，首页未显示。修改：处于这两个界面时不允许点击顶部栏界面按钮
- [ ] 软件设计方面问题：1、软件未开启，设备运行，这阶段的部分数据是无法得到的。例如某一模块运行的时长无法获取
      2、软件开启，设备运行过程中，关闭软件、可能丢失某模块数据的采集
- [x] 软件使用说明书编写
- [x] 增加社会效益
- [x] 招标参数修改
- [x] 首页‘制氢量’图的label超出边界，增加总制氢量的数据单位
- [x] 实时监控页，设备运行状态判断（有一个模块发生告警，则显示系统告警）。设备信息展示



### 测试修改
-  登录界面：
  - [x]  忘记密码和联系方式是一个弹窗？忘记密码的弹窗可以设置成短信验证成功后，将密码发送给对方的形式
  - [x]  登录密码增加可视化模式，横框右侧添加个眼睛的图标
-  首页：
   - [x] 所有数据的单位要加上
   - [x] 左上角的软件名称把版本号也加上
   - [x]  账号、退出符号尺寸与最小化、最大化符号尺寸一致
   - [x]  中间的各模块名称的间距要拉大。
   - [x] “储氢量”改成“制氢量”
   - [x]  当日制氢量增加光电制氢量和市电制氢量两个数据
-  实时监控：
   - [x] 系统监控：单位（制氢量mL、发电量W）
   - [x] 水电解槽的输入功率单位错了
- [x] 数据查询：不筛查时是显示所有时期的数据
- [x] 故障告警：滚动速度太慢了，加快一点
- [x] 界面缩小之后，右上角的放大框上下框边缘不清晰
- [x] 登录页修改，界面修改 ，增加最小化，最大化、关闭按钮
20221028
- [x] 氢气浓度判断，不属于水电解槽模块，需单独判断
- [x] plc重连操作，改为断线重连三次
- [x] 折线图数据进行四舍五入保留三位小数
- [x] 告警状态UI替换
- [x] 设备关闭时，红灯闪烁；开始后1-5s黄灯闪烁。与plc联合测试
  

### 备忘
  - 软件数据库修改：  
    - 1、增加制氢量与发电量实时监控表：该表存储当日实时数据，时段为8：00-21：00，每五分钟存储一次。用户下次登录进行表数据的清除，重新进行存储（或者进行表数据的更新）
    - 2、增加制氢量与发电量历史数据表：包括时间、供电功率、日制氢量、日发电量、总制氢量、总发电量、运行时长、总运行时长。（日制氢量指的当日总的制氢量，总制氢量指的是截止到当前时段累积日制氢量之和。日发电量与运行时长同理）
    - 3、增加历史运行数据表：时间、电源输入功率、输入电压、输入电流、制氢量、氢气外送量、燃料电池发电功率、燃料电池输出电压、燃料电池输出电流
    - 4、增加故障告警历史信息表
    - 5、增加联系我们中信息表：联系人、电话、微信、qq、邮箱
  - 增加软件定时器工具
  - 缺少PLC数据计算公式方法、非PLC数值的数据来源
  - 某些数据是否需要计算公式、或者具体判断条件，部分数据缺少PLC数据来源,数据结构Xmind文件部分界面数据未列出
  
  - 触摸屏按下急停，plc与unity依然保持连接状态
  - 当日燃料电池、市电、光伏、水电解槽运行时长需及时进行更新保存

### 软件结束
  - 进行3D仿真规划“数据保存不成功”问题的解决。
  - 概算、经评bug
  - 智慧新能源（.net）,分布式光伏（3D）,可再生能源（3D）
 
  



